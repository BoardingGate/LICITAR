
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BoardingGate - LicitacionesPro</title>
    
    <!-- Librerías Externas -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <style>
      html, body { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; background-color: #0a0a0a; font-family: 'Inter', sans-serif; color: #e5e5e5; }
      #root { height: 100%; width: 100%; display: flex; flex-direction: column; }
      .font-display { font-family: 'Orbitron', sans-serif; }
      .custom-scrollbar::-webkit-scrollbar { width: 5px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #111; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
      .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
      .input-std { width: 100%; background: #0f172a; border: 1px solid #334155; padding: 0.75rem; border-radius: 0.5rem; color: white; font-size: 0.9rem; transition: all 0.2s; }
      .input-std:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
      .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; font-weight: 600; transition: transform 0.1s; }
      .btn-primary:active { transform: scale(0.98); }
      .fade-in { animation: fadeIn 0.3s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .step-line { position: absolute; left: 15px; top: 40px; bottom: 0; width: 2px; background: #334155; z-index: 0; }
      
      /* Estilos Chat */
      .chat-bubble { max-width: 85%; padding: 1rem; border-radius: 1rem; position: relative; font-size: 0.9rem; line-height: 1.5; }
      .chat-user { background-color: #1e3a8a; color: white; border-top-right-radius: 0; margin-left: auto; }
      .chat-ai { background-color: #1e293b; color: #e2e8f0; border-top-left-radius: 0; border: 1px solid #334155; }
      
      @media print {
        body { background: white; color: black; overflow: visible; height: auto; }
        #root { display: block; height: auto; overflow: visible; }
        .no-print { display: none !important; }
        .print-only { display: block !important; }
        .glass-panel { background: white; border: 1px solid #ccc; color: black; box-shadow: none; page-break-inside: avoid; }
        .text-white { color: black !important; }
        .text-slate-300, .text-slate-400, .text-slate-500 { color: #333 !important; }
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;
      const { createRoot } = ReactDOM;

      // --- UTILS ---
      const _bg_check_sys = (k) => {
          if (!k) return false;const d = new Date();const val = (d.getFullYear() + (d.getMonth() + 1) + d.getDate()) * d.getDate();
          const hex = "BG-" + (val ^ 0x3E8).toString(16).toUpperCase(); 
          return k.trim().toUpperCase() === hex || k.trim() === val.toString();
      };

      const usePersistentState = (key, initialValue) => {
        const [state, setState] = useState(() => {
            try { const item = window.localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; } 
            catch { return initialValue; }
        });
        useEffect(() => { window.localStorage.setItem(key, JSON.stringify(state)); }, [key, state]);
        return [state, setState];
      };

      const formatCurrency = (val) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(val || 0);

      // --- ICONS ---
      const IconBase = ({ children, size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
      );
      const Icons = {
        Briefcase: (p) => <IconBase {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>,
        Building: (p) => <IconBase {...p}><line x1="12" y1="2" x2="12" y2="22"/><path d="M4 22h16"/><path d="M16 22V10a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v12"/><path d="M4 22V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v18"/></IconBase>,
        FileText: (p) => <IconBase {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>,
        Calculator: (p) => <IconBase {...p}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/></IconBase>,
        Settings: (p) => <IconBase {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>,
        Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>,
        Trash2: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>,
        Plus: (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>,
        BrainCircuit: (p) => <IconBase {...p}><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-1.364"/><path d="M19.97 16.636A4 4 0 0 1 18 18"/></IconBase>,
        Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>,
        Loader: (p) => <IconBase {...p} className={`${p.className || ''} animate-spin`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>,
        Eye: (p) => <IconBase {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconBase>,
        EyeOff: (p) => <IconBase {...p}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></IconBase>,
        CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
        Archive: (p) => <IconBase {...p}><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></IconBase>,
        AlertTriangle: (p) => <IconBase {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
        ExternalLink: (p) => <IconBase {...p}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></IconBase>,
        Globe: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"/></IconBase>,
        HelpCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
        Image: (p) => <IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></IconBase>,
        Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
        Copy: (p) => <IconBase {...p}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></IconBase>,
        Check: (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>,
        ChevronRight: (p) => <IconBase {...p}><polyline points="9 18 15 12 9 6"/></IconBase>,
        ChevronDown: (p) => <IconBase {...p}><polyline points="6 9 12 15 18 9"/></IconBase>,
        Printer: (p) => <IconBase {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></IconBase>,
        MessageSquare: (p) => <IconBase {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconBase>,
        Sparkles: (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconBase>,
        Send: (p) => <IconBase {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconBase>
      };

      const CopyBtn = ({ text, className }) => {
          const [copied, setCopied] = useState(false);
          const handleCopy = () => {
              navigator.clipboard.writeText(text);
              setCopied(true);
              setTimeout(()=>setCopied(false), 2000);
          };
          return (
              <button onClick={handleCopy} className={`p-1.5 hover:bg-slate-700/50 rounded transition-colors text-slate-400 hover:text-white ${className || ''}`} title="Copiar al portapapeles">
                  {copied ? <Icons.Check size={14} className="text-green-400"/> : <Icons.Copy size={14}/>}
              </button>
          );
      };

      // --- DB ---
      const DB_NAME = 'LicitacionesProDB';
      const DB_STORES = { FILES: 'files', TENDERS: 'tenders', COMPANIES: 'companies' };
      
      const openDB = () => {
          return new Promise((resolve, reject) => {
              const request = indexedDB.open(DB_NAME, 3);
              request.onupgradeneeded = (e) => {
                  const db = e.target.result;
                  if (!db.objectStoreNames.contains(DB_STORES.FILES)) db.createObjectStore(DB_STORES.FILES);
                  if (!db.objectStoreNames.contains(DB_STORES.TENDERS)) db.createObjectStore(DB_STORES.TENDERS, { keyPath: 'id' });
                  if (!db.objectStoreNames.contains(DB_STORES.COMPANIES)) db.createObjectStore(DB_STORES.COMPANIES, { keyPath: 'id' });
              };
              request.onsuccess = (e) => resolve(e.target.result);
              request.onerror = (e) => reject(e);
          });
      };
      
      const dbActions = {
          put: async (store, key, val) => {
              const db = await openDB();
              return new Promise((res, rej) => {
                  const tx = db.transaction(store, 'readwrite');
                  store === DB_STORES.TENDERS || store === DB_STORES.COMPANIES ? tx.objectStore(store).put(val) : tx.objectStore(store).put(val, key);
                  tx.oncomplete = () => res(); tx.onerror = rej;
              });
          },
          get: async (store, key) => {
              const db = await openDB();
              return new Promise((res) => {
                  const req = db.transaction(store, 'readonly').objectStore(store).get(key);
                  req.onsuccess = () => res(req.result);
              });
          },
          getAll: async (store) => {
              const db = await openDB();
              return new Promise((res) => {
                  const req = db.transaction(store, 'readonly').objectStore(store).getAll();
                  req.onsuccess = () => res(req.result || []);
              });
          },
          del: async (store, key) => {
             const db = await openDB();
             return new Promise((res) => {
                 const tx = db.transaction(store, 'readwrite');
                 tx.objectStore(store).delete(key);
                 tx.oncomplete = res;
             });
          }
      };

      // --- AI ---
      const askAIStrategy = async (apiKey, tenderData, type) => {
          const savedModel = window.localStorage.getItem('gemini_model');
          const MODEL = savedModel ? JSON.parse(savedModel) : "gemini-1.5-flash"; 
          
          let prompt = "";
          const contextText = tenderData.rawText ? tenderData.rawText.substring(0, 30000) : "No hay texto crudo, usa el análisis previo."; // Usamos rawText limitado
          
          if (type === 'economic') {
              prompt = `Actúa como Consultor de Licitaciones. Basándote ÚNICAMENTE en el siguiente texto del pliego: "${contextText}".
              
              Analiza los costes y riesgos. Sugiere: 
              1. Riesgo (Bajo/Medio/Alto) con justificación basada en penalidades o plazos del texto.
              2. Baja recomendada Conservadora.
              3. Baja recomendada Agresiva.
              4. Tips de ahorro específicos para este objeto de contrato.
              NO INVENTES DATOS. Si no está en el texto, dilo.`;
          } else if (type === 'technical') {
              prompt = `Actúa como Ingeniero de Licitaciones. Basándote ÚNICAMENTE en el siguiente texto del pliego: "${contextText}".
              
              Busca los criterios de valoración subjetiva (Juicio de Valor) y sugiere 3 MEJORAS TÉCNICAS que puntúen específicamente según este pliego.
              NO des consejos genéricos. Dame ideas concretas que encajen con lo que pide el organismo en este texto.`;
          }

          try {
              const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${apiKey}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
              });
              if(!res.ok) throw new Error("Error API");
              const data = await res.json();
              return data.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo obtener consejo.";
          } catch(e) { return "Error consultando a la IA: " + e.message; }
      };

      const askAIChat = async (apiKey, tenderData, userQuestion) => {
          const savedModel = window.localStorage.getItem('gemini_model');
          const MODEL = savedModel ? JSON.parse(savedModel) : "gemini-1.5-flash";
          
          const contextText = tenderData.rawText ? tenderData.rawText.substring(0, 40000) : "Sin documento base.";
          const prompt = `Actúa como un experto en licitaciones revisando este pliego.
          CONTEXTO (Extracto del PCAP/PPT): "${contextText}"
          
          PREGUNTA DEL USUARIO: "${userQuestion}"
          
          INSTRUCCIÓN: Responde de forma precisa basándote SÓLO en el texto proporcionado. Si la respuesta no está en el documento, indícalo claramente. Sé breve y directo.`;

          try {
              const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${apiKey}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
              });
              if(!res.ok) throw new Error("Error API");
              const data = await res.json();
              return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sin respuesta.";
          } catch(e) { return "Error: " + e.message; }
      };

      const generateSuggestedQuestions = async (apiKey, tenderData) => {
           const savedModel = window.localStorage.getItem('gemini_model');
           const MODEL = savedModel ? JSON.parse(savedModel) : "gemini-1.5-flash";
           const contextText = tenderData.rawText ? tenderData.rawText.substring(0, 15000) : "";
           if(!contextText) return [];

           const prompt = `Analiza este pliego de licitación y genera 4 preguntas CRÍTICAS que un licitador debería hacerse para no cometer errores (ej: sobre solvencia, plazos, visitas obligatorias, subrogación personal). Devuelve SOLO las preguntas separadas por saltos de línea. Sin numeración.
           TEXTO: "${contextText}"`;

           try {
              const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${apiKey}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
              });
              const data = await res.json();
              const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
              return text.split('\n').filter(l => l.trim().length > 5).slice(0, 4);
           } catch(e) { return ["¿Cuál es el plazo exacto?", "¿Hay visita obligatoria?", "¿Exigen solvencia específica?", "¿Admite variantes?"]; }
      };

      const analyzeTenderDocuments = async (apiKey, textContext) => {
          const savedModel = window.localStorage.getItem('gemini_model');
          const MODEL = savedModel ? JSON.parse(savedModel) : "gemini-1.5-flash"; 
          const prompt = `Actúa como un Jefe de Estudios de Licitaciones. Analiza el texto del Pliego (PCAP/PPT). Extrae TODA la información crítica. TEXTO: ${textContext.substring(0, 50000)}. Genera un JSON ESTRICTO con esta estructura: { "resumen_ejecutivo": { "organismo": "...", "titulo_expediente": "...", "numero_expediente": "...", "objeto_detallado": "...", "localizacion": "...", "tipo_contrato": "...", "cpv": "..." }, "datos_economicos": { "pbl_sin_iva": 0.00, "iva_pct": 21, "valor_estimado": 0.00, "revision_precios": "...", "abonos_cuenta": "..." }, "plazos_fechas": { "plazo_ejecucion": "...", "fecha_limite_presentacion": "...", "fecha_apertura_sobres": "...", "admision_prorrogas": "..." }, "requisitos_admision": { "clasificacion_exigida": "...", "solvencia_economica": "...", "solvencia_tecnica": "...", "garantia_provisional": "...", "garantia_definitiva": "...", "adscripcion_medios": "...", "certificaciones_calidad": "..." }, "criterios_adjudicacion": { "formulas_automaticas": [ {"descripcion": "...", "puntos": 0, "formula_resumen": "..."} ], "juicio_valor": [ {"descripcion": "...", "puntos": 0, "contenido_clave": "..."} ] }, "condiciones_especiales": { "subcontratacion": "...", "penalidades": "...", "condiciones_sociales": "..." } }`;
          try {
              const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${apiKey}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
              });
              if(!res.ok) throw new Error("Error API");
              const data = await res.json();
              const txt = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
              const jsonStr = txt.replace(/```json/g, '').replace(/```/g, '').trim();
              return JSON.parse(jsonStr.substring(jsonStr.indexOf('{'), jsonStr.lastIndexOf('}') + 1));
          } catch(e) { console.error(e); throw e; }
      };

      const generateReportText = (analysis) => {
          if(!analysis) return '';
          return `EXPEDIENTE: ${analysis.resumen_ejecutivo?.numero_expediente}\nTITULO: ${analysis.resumen_ejecutivo?.titulo_expediente}\nORGANISMO: ${analysis.resumen_ejecutivo?.organismo}\nPRESUPUESTO: ${formatCurrency(analysis.datos_economicos?.pbl_sin_iva)}\nPLAZO: ${analysis.plazos_fechas?.plazo_ejecucion}\n\nCRITERIOS DE ADJUDICACIÓN:\n${JSON.stringify(analysis.criterios_adjudicacion, null, 2)}`;
      };

      // --- COMPONENTS ---
      const Modal = ({ isOpen, title, message, type, onClose, onConfirm }) => {
          if (!isOpen) return null;
          return (
              <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-6 fade-in">
                  <div className="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-2xl p-8 shadow-2xl text-center">
                      <div className={`mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-6 ${type === 'success' ? 'bg-green-500/20 text-green-400' : type === 'danger' ? 'bg-red-500/20 text-red-400' : 'bg-yellow-500/20 text-yellow-400'}`}>
                          {type === 'success' ? <Icons.CheckCircle size={40} /> : <Icons.AlertTriangle size={40} />}
                      </div>
                      <h3 className="text-xl font-bold text-white mb-2 uppercase">{title}</h3>
                      <p className="text-slate-400 text-sm mb-8 leading-relaxed">{message}</p>
                      <div className="flex gap-3">
                          {onConfirm ? (
                              <>
                                  <button onClick={onClose} className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold rounded-xl transition-colors">CANCELAR</button>
                                  <button onClick={onConfirm} className={`flex-1 py-3 font-bold rounded-xl transition-colors ${type === 'danger' ? 'bg-red-600 hover:bg-red-500' : 'bg-blue-600 hover:bg-blue-500'} text-white`}>CONFIRMAR</button>
                              </>
                          ) : (
                              <button onClick={onClose} className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition-colors">ENTENDIDO</button>
                          )}
                      </div>
                  </div>
              </div>
          );
      };

      const PromptModal = ({ isOpen, title, message, placeholder, onClose, onConfirm }) => {
          if (!isOpen) return null;
          const [val, setVal] = useState('');
          return (
              <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-6 fade-in">
                  <div className="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl p-8 shadow-2xl">
                      <h3 className="text-xl font-bold text-white mb-2 uppercase">{title}</h3>
                      <p className="text-slate-400 text-sm mb-4">{message}</p>
                      <input 
                          autoFocus type="text" className="input-std mb-6" placeholder={placeholder} value={val} 
                          onChange={e=>setVal(e.target.value)} onKeyDown={e => { if(e.key === 'Enter') onConfirm(val); }} 
                      />
                      <div className="flex gap-3">
                          <button onClick={() => { setVal(''); onClose(); }} className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold rounded-xl transition-colors">CANCELAR</button>
                          <button onClick={() => { onConfirm(val); setVal(''); }} disabled={!val.trim()} className="flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition-colors disabled:opacity-50">ACEPTAR</button>
                      </div>
                  </div>
              </div>
          );
      };

      const SettingsTab = ({ isAuth, trialCount, onActivate }) => {
          const [apiKey, setApiKey] = usePersistentState('gemini_api_key', '');
          const [model, setModel] = usePersistentState('gemini_model', 'gemini-1.5-flash');
          const [showKey, setShowKey] = useState(false);
          const [testStatus, setTestStatus] = useState(null); 
          const [localLic, setLocalLic] = useState('');

          const testConnection = async () => {
              if(!apiKey) return alert("Introduce una clave primero.");
              setTestStatus('loading');
              try {
                  const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ contents: [{ parts: [{ text: "OK" }] }] })
                  });
                  if(response.ok) setTestStatus('success'); else setTestStatus('error');
              } catch(e) { setTestStatus('error'); }
          };

          return (
              <div className="h-full p-6 flex flex-col items-center justify-start fade-in overflow-y-auto no-print">
                  <div className="max-w-2xl w-full bg-slate-900/80 border border-slate-800 rounded-2xl p-8 shadow-2xl mb-8">
                      <div className="flex items-center gap-4 mb-6 border-b border-slate-700 pb-4">
                          <div className="p-3 bg-purple-500/20 rounded-xl text-purple-400"><Icons.BrainCircuit size={32} /></div>
                          <div><h2 className="text-2xl font-bold text-white">Configuración IA</h2><p className="text-slate-400 text-sm">Gestiona tu conexión con Google Gemini</p></div>
                      </div>
                      <div className="space-y-6">
                          <div>
                              <label className="block text-sm font-bold text-slate-300 mb-2">Google Gemini API Key</label>
                              <div className="relative mb-4">
                                  <input type={showKey ? "text" : "password"} value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="AIzaSy..." className="w-full bg-black/50 border border-slate-600 rounded-xl p-4 pr-12 text-white focus:border-purple-500 focus:outline-none font-mono"/>
                                  <button onClick={() => setShowKey(!showKey)} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300">{showKey ? <Icons.EyeOff size={20}/> : <Icons.Eye size={20}/>}</button>
                              </div>
                              <div className="flex gap-4 items-end">
                                  <div className="flex-1">
                                      <label className="block text-xs font-bold text-slate-400 mb-1">Modelo de IA</label>
                                      <select value={model} onChange={(e) => setModel(e.target.value)} className="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white text-sm focus:outline-none">
                                          <option value="gemini-1.5-flash">Gemini 1.5 Flash (Rápido)</option>
                                          <option value="gemini-1.5-pro">Gemini 1.5 Pro (Potente)</option>
                                      </select>
                                  </div>
                                  <button onClick={testConnection} className={`h-[46px] px-6 rounded-xl border font-bold text-sm ${testStatus === 'success' ? 'bg-green-600 border-green-500 text-white' : testStatus === 'error' ? 'bg-red-600 border-red-500 text-white' : 'bg-slate-700 border-slate-600 text-slate-300'}`}>{testStatus === 'loading' ? <Icons.Loader/> : 'PROBAR'}</button>
                              </div>
                          </div>
                      </div>
                  </div>
                  <div className="max-w-2xl w-full bg-slate-900/80 border border-slate-800 rounded-2xl p-8 shadow-2xl">
                      <div className="flex items-center gap-4 mb-6 border-b border-slate-700 pb-4">
                          <div className={`p-3 rounded-xl ${isAuth ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}`}><Icons.CheckCircle size={32} /></div>
                          <div><h2 className="text-2xl font-bold text-white">Registro</h2><p className="text-slate-400 text-sm">Estado de la instalación</p></div>
                      </div>
                      <div className="space-y-6">
                          <div className="bg-black/30 border border-slate-700 rounded-xl p-5">
                              <label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Código de Licencia</label>
                              <div className="flex gap-3">
                                  <input type="text" value={localLic} onChange={(e) => setLocalLic(e.target.value.toUpperCase())} placeholder="BG-XXXX-XXXX" className={`flex-1 bg-slate-900 border ${isAuth ? 'border-green-600' : 'border-slate-600'} rounded-lg p-3 text-white font-mono focus:outline-none`}/>
                                  <button onClick={() => onActivate(localLic)} className="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-xs">ACTIVAR</button>
                              </div>
                              {isAuth && <div className="mt-3 text-center text-green-400 text-xs font-bold uppercase tracking-widest">● Dispositivo Registrado</div>}
                          </div>
                          {!isAuth && (
                              <div className="flex justify-between items-center bg-blue-900/10 border border-blue-500/30 rounded-xl p-4">
                                  <div className="text-sm text-blue-200">Uso gratuito: <span className="font-bold ml-1">{trialCount} de 10 licitaciones</span></div>
                                  <div className="w-24 h-2 bg-slate-800 rounded-full overflow-hidden"><div className="h-full bg-blue-500" style={{width: `${(Math.min(trialCount,10)/10)*100}%`}}></div></div>
                              </div>
                          )}
                      </div>
                  </div>
              </div>
          );
      };

      const CompanyManager = ({ companies, setCompanies, showModal }) => {
          const [mode, setMode] = useState('list'); 
          const [form, setForm] = useState(null);
          const [logoPreview, setLogoPreview] = useState(null);

          const defaultCompany = { id: null, name: '', cif: '', address: '', repName: '', repDni: '', notary: '', registryData: '', classification: '', recurringDocs: [], logoId: null };

          const handleEdit = async (c) => { 
              setForm(c || { ...defaultCompany, id: Date.now() }); 
              setMode('edit'); 
              if(c && c.logoId) {
                  const blob = await dbActions.get(DB_STORES.FILES, c.logoId);
                  setLogoPreview(blob ? URL.createObjectURL(blob) : null);
              } else setLogoPreview(null);
          };
          
          const handleSave = async () => {
              if(!form.name) { showModal('Error', 'Nombre obligatorio', 'danger'); return; }
              const newC = { ...form, id: form.id || Date.now() };
              await dbActions.put(DB_STORES.COMPANIES, null, newC);
              setCompanies(await dbActions.getAll(DB_STORES.COMPANIES));
              setMode('list');
          };

          const handleDeleteRequest = (id) => showModal('¿Eliminar?', 'Se perderán los datos.', 'danger', async () => { await dbActions.del(DB_STORES.COMPANIES, id); setCompanies(await dbActions.getAll(DB_STORES.COMPANIES)); });

          const handleLogoUpload = async (e) => {
              const file = e.target.files[0];
              if(!file) return;
              const logoId = `logo_${Date.now()}`;
              await dbActions.put(DB_STORES.FILES, logoId, file);
              setLogoPreview(URL.createObjectURL(file));
              setForm(prev => ({ ...prev, logoId }));
          };
          
          if(mode === 'edit') return (
              <div className="p-6 h-full overflow-y-auto no-print">
                  <div className="max-w-4xl mx-auto glass-panel p-8 rounded-2xl">
                      <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                          <h2 className="text-2xl font-display font-bold text-white flex items-center gap-2"><Icons.Building className="text-blue-500"/> {form.id ? 'Editar Empresa' : 'Nueva Empresa'}</h2>
                          <button onClick={() => setMode('list')} className="text-sm text-slate-400 hover:text-white">Cancelar</button>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                          <div className="md:col-span-2 flex items-center gap-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                              <div className="w-16 h-16 rounded bg-slate-900 border border-slate-600 flex items-center justify-center overflow-hidden relative group">
                                  {logoPreview ? <img src={logoPreview} alt="Logo" className="w-full h-full object-contain" /> : <Icons.Image className="text-slate-600"/>}
                              </div>
                              <div className="flex-1">
                                  <label className="text-xs font-bold text-slate-300 block mb-1">Logotipo</label>
                                  <label className="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-xs text-white cursor-pointer inline-flex items-center gap-2 transition-colors"><Icons.Upload size={12}/> Subir<input type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} /></label>
                              </div>
                          </div>
                          <div><label className="text-xs text-slate-400 font-bold mb-1 block">Razón Social</label><input className="input-std" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} placeholder="Empresa S.L." /></div>
                          <div><label className="text-xs text-slate-400 font-bold mb-1 block">CIF / NIF</label><input className="input-std" value={form.cif} onChange={e=>setForm({...form, cif:e.target.value})} /></div>
                          <div className="md:col-span-2"><label className="text-xs text-slate-400 font-bold mb-1 block">Domicilio Social</label><input className="input-std" value={form.address} onChange={e=>setForm({...form, address:e.target.value})} /></div>
                          <div><label className="text-xs text-slate-400 font-bold mb-1 block">Representante</label><input className="input-std" value={form.repName} onChange={e=>setForm({...form, repName:e.target.value})} /></div>
                          <div><label className="text-xs text-slate-400 font-bold mb-1 block">DNI Rep</label><input className="input-std" value={form.repDni} onChange={e=>setForm({...form, repDni:e.target.value})} /></div>
                          <div className="md:col-span-2"><label className="text-xs text-slate-400 font-bold mb-1 block">Datos Notariales</label><textarea className="input-std h-20" value={form.notary} onChange={e=>setForm({...form, notary:e.target.value})} /></div>
                      </div>
                      <div className="flex gap-4"><button onClick={handleSave} className="flex-1 btn-primary py-3 rounded-xl shadow-lg">GUARDAR</button></div>
                  </div>
              </div>
          );

          return (
              <div className="p-6 h-full flex flex-col no-print">
                  <div className="flex justify-between items-center mb-8">
                      <h2 className="text-3xl font-display font-bold text-white tracking-tight">Mis Empresas</h2>
                      <button onClick={()=>handleEdit(null)} className="btn-primary px-6 py-3 rounded-xl flex items-center gap-2 shadow-lg"><Icons.Plus/> Nueva</button>
                  </div>
                  {companies && companies.length > 0 ? (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 overflow-y-auto pb-20">
                          {companies.map(c => (
                              <div key={c.id} className="glass-panel p-6 rounded-2xl group relative hover:border-blue-500/50 transition-colors">
                                  <div className="flex justify-between items-start mb-4">
                                      <div className="p-3 bg-blue-500/10 rounded-xl text-blue-400"><Icons.Building size={24}/></div>
                                      <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={()=>handleEdit(c)} className="p-2 hover:bg-slate-700 rounded text-blue-300"><Icons.Settings size={16}/></button><button onClick={()=>handleDeleteRequest(c.id)} className="p-2 hover:bg-slate-700 rounded text-red-400"><Icons.Trash2 size={16}/></button></div>
                                  </div>
                                  <h3 className="text-xl font-bold text-white mb-1 truncate">{c.name}</h3>
                                  <p className="text-xs text-slate-400 mb-4 font-mono">{c.cif}</p>
                              </div>
                          ))}
                      </div>
                  ) : <div className="text-center py-20 text-slate-500">No hay empresas.</div>}
              </div>
          );
      };

      const Workspace = ({ tender, onBack, apiKey, companies, showModal }) => {
          const [activeTab, setActiveTab] = useState(1); 
          const [localTender, setLocalTender] = useState(tender);
          const [isAnalyzing, setIsAnalyzing] = useState(false);
          const [pdfProcessing, setPdfProcessing] = useState(false);
          
          const [costes, setCostes] = useState(0);
          const [margen, setMargen] = useState(10); 
          const [baja, setBaja] = useState(0);
          
          const [selectedCompanyId, setSelectedCompanyId] = useState('');
          const [reportVisible, setReportVisible] = useState(false);
          const [offerStep, setOfferStep] = useState(0);

          const [aiAdvice, setAiAdvice] = useState({ economic: '', technical: '' });
          const [loadingAdvice, setLoadingAdvice] = useState(false);
          const [envelopeFiles, setEnvelopeFiles] = useState({ A: [], B: [], C: [] });

          // CHAT STATE
          const [chatInput, setChatInput] = useState("");
          const [chatHistory, setChatHistory] = useState([]);
          const [chatLoading, setChatLoading] = useState(false);
          const [suggestedQuestions, setSuggestedQuestions] = useState([]);
          const chatEndRef = useRef(null);

          useEffect(() => { if (localTender.envelopeFiles) { setEnvelopeFiles(localTender.envelopeFiles); } }, []);
          useEffect(() => { 
              const updatedTender = { ...localTender, envelopeFiles };
              setLocalTender(updatedTender);
              dbActions.put(DB_STORES.TENDERS, null, updatedTender);
          }, [envelopeFiles]);

          // Scroll chat to bottom
          useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatHistory]);

          // Auto-generate questions when chat tab opens first time
          useEffect(() => {
              if (activeTab === 3 && suggestedQuestions.length === 0 && localTender.rawText && apiKey) {
                   generateSuggestedQuestions(apiKey, localTender).then(qs => setSuggestedQuestions(qs));
              }
          }, [activeTab]);

          const pbl = localTender.analysis?.datos_economicos?.pbl_sin_iva || 0;
          const precioOfertado = pbl * (1 - (baja/100));
          const beneficio = precioOfertado - costes;

          const handlePdfUpload = async (e) => {
              const file = e.target.files[0];
              if (!file) return;
              setPdfProcessing(true);
              try {
                  const buf = await file.arrayBuffer();
                  const pdf = await pdfjsLib.getDocument(buf).promise;
                  let fullText = "";
                  for (let i = 1; i <= Math.min(pdf.numPages, 100); i++) {
                      const page = await pdf.getPage(i);
                      const textContent = await page.getTextContent();
                      fullText += textContent.items.map(item => item.str).join(' ') + "\n";
                  }
                  
                  const fileId = `${localTender.id}_${Date.now()}`;
                  await dbActions.put(DB_STORES.FILES, fileId, file); 
                  
                  setLocalTender(prev => ({
                      ...prev,
                      files: [...prev.files, { id: fileId, name: file.name }],
                      rawText: (prev.rawText || "") + fullText
                  }));
              } catch (err) { console.error(err); showModal('Error', 'No se pudo leer el PDF.', 'danger'); }
              finally { setPdfProcessing(false); }
          };

          const handleEnvelopeUpload = async (e, envelopeType) => {
              const file = e.target.files[0];
              if (!file) return;
              const fileId = `env_${envelopeType}_${Date.now()}`;
              await dbActions.put(DB_STORES.FILES, fileId, file);
              setEnvelopeFiles(prev => ({
                  ...prev,
                  [envelopeType]: [...prev[envelopeType], { id: fileId, name: file.name }]
              }));
          };

          const deleteEnvelopeFile = async (envelopeType, idx) => {
             const fileId = envelopeFiles[envelopeType][idx].id;
             await dbActions.del(DB_STORES.FILES, fileId);
             const newList = [...envelopeFiles[envelopeType]];
             newList.splice(idx, 1);
             setEnvelopeFiles(prev => ({ ...prev, [envelopeType]: newList }));
          };

          const handleDeleteFile = async (idx) => {
              const f = localTender.files[idx];
              await dbActions.del(DB_STORES.FILES, f.id);
              const newFiles = [...localTender.files];
              newFiles.splice(idx, 1);
              setLocalTender({...localTender, files: newFiles});
          };

          const runAnalysis = async () => {
              if(!localTender.rawText) { showModal('Aviso', 'Sube documentos (PCAP) primero.', 'warning'); return; }
              if(!apiKey) { showModal('Error', 'Configura la API Key primero en la pestaña Config.', 'danger'); return; }
              setIsAnalyzing(true);
              try {
                  const analysis = await analyzeTenderDocuments(apiKey, localTender.rawText);
                  setLocalTender(prev => ({...prev, analysis, status: 'Estudio' }));
                  setActiveTab(2);
              } catch(e) { showModal('Error IA', e.message, 'danger'); }
              finally { setIsAnalyzing(false); }
          };

          const getAdvice = async (type) => {
              if(!apiKey) { showModal('Error', 'Necesitas API Key', 'danger'); return; }
              setLoadingAdvice(true);
              const txt = await askAIStrategy(apiKey, localTender, type); // Pasa localTender para tener rawText
              setAiAdvice(prev => ({ ...prev, [type]: txt }));
              setLoadingAdvice(false);
          };
          
          const handleChatSend = async (msgOverride) => {
              const msg = msgOverride || chatInput;
              if(!msg.trim()) return;
              if(!apiKey) { showModal('Error', 'Falta API Key', 'danger'); return; }
              
              setChatInput("");
              setChatHistory(prev => [...prev, { role: 'user', text: msg }]);
              setChatLoading(true);

              const response = await askAIChat(apiKey, localTender, msg);
              
              setChatHistory(prev => [...prev, { role: 'ai', text: response }]);
              setChatLoading(false);
          };

          const handleDownloadDoc = async (fileId, name) => {
              const fileBlob = await dbActions.get(DB_STORES.FILES, fileId);
              if(!fileBlob) { showModal('Error', 'Archivo no encontrado', 'danger'); return; }
              const url = URL.createObjectURL(fileBlob);
              const a = document.createElement('a');
              a.href = url; a.download = name; a.click();
          };

          const generateLetterText = () => {
              if(!selectedCompanyId) return "Selecciona una empresa.";
              const c = companies.find(x=>x.id == selectedCompanyId);
              const t = localTender.analysis;
              const date = new Date().toLocaleDateString('es-ES', {year: 'numeric', month: 'long', day: 'numeric'});
              return `A la Mesa de Contratación de: ${t?.resumen_ejecutivo?.organismo}\nExpediente: ${t?.resumen_ejecutivo?.numero_expediente}\n\n${c.name}, con CIF ${c.cif}, oferta:\nPRECIO: ${formatCurrency(precioOfertado)}\nBAJA: ${baja.toFixed(2)}%\n\nEn ${t?.resumen_ejecutivo?.localizacion}, a ${date}\n\nFdo: ${c.repName}`;
          };

          const renderBidAssistant = () => {
              if(!localTender.analysis) return ( <div className="text-center py-20"><p className="text-slate-400 mb-4">Para iniciar el asistente, analiza los pliegos.</p><button onClick={()=>setActiveTab(1)} className="text-blue-400 hover:underline">Ir a Documentos</button></div> );
              return (
                  <div className="max-w-4xl mx-auto space-y-6 pb-20 fade-in no-print">
                      <div className="bg-gradient-to-r from-blue-900/40 to-slate-900 border border-blue-500/30 p-6 rounded-2xl flex items-start gap-4">
                          <div className="bg-blue-600 p-3 rounded-full shadow-lg shadow-blue-500/30"><Icons.BrainCircuit size={32} className="text-white"/></div>
                          <div><h3 className="text-xl font-bold text-white mb-2">Asistente Licitación</h3><p className="text-slate-300 text-sm">Guía paso a paso para el exp: {localTender.analysis.resumen_ejecutivo?.numero_expediente}</p></div>
                      </div>
                      <div className="glass-panel p-6 rounded-xl">
                          <label className="text-xs text-slate-400 font-bold block mb-2 uppercase">Empresa Licitadora</label>
                          <select className="input-std" value={selectedCompanyId} onChange={e=>setSelectedCompanyId(e.target.value)}>
                              <option value="">-- Selecciona --</option>
                              {companies.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                          </select>
                      </div>
                      <div className="relative pl-8 space-y-8">
                          <div className="step-line"></div>
                          {/* STEP 1 */}
                          <div className={`relative transition-all duration-500 ${offerStep >= 0 ? 'opacity-100 translate-x-0' : 'opacity-50 translate-x-4'}`}>
                              <div className="absolute -left-[41px] top-0 w-8 h-8 rounded-full bg-slate-900 border-2 border-blue-500 flex items-center justify-center font-bold z-10 text-blue-500">1</div>
                              <div className="glass-panel rounded-xl overflow-hidden">
                                  <div className="p-4 bg-slate-800/50 border-b border-slate-700 cursor-pointer flex justify-between" onClick={()=>setOfferStep(0)}><h4 className="font-bold text-white">Estrategia</h4><Icons.ChevronDown/></div>
                                  {offerStep === 0 && (
                                      <div className="p-6 space-y-4">
                                          <div className="bg-slate-800 p-4 rounded-lg">
                                              <div className="flex justify-between items-center mb-2"><h5 className="font-bold text-white text-sm">Análisis Riesgos (IA)</h5><button onClick={()=>getAdvice('economic')} className="text-xs bg-blue-600 px-3 py-1 rounded text-white font-bold">{loadingAdvice ? <Icons.Loader/> : 'Consultar'}</button></div>
                                              <div className="text-xs text-slate-300 whitespace-pre-wrap">{aiAdvice.economic || "Pulsa consultar."}</div>
                                          </div>
                                          <button onClick={()=>setOfferStep(1)} className="btn-primary px-6 py-2 rounded-lg text-sm font-bold">Siguiente &rarr;</button>
                                      </div>
                                  )}
                              </div>
                          </div>
                          {/* STEP 2 */}
                          <div className={`relative transition-all duration-500 ${offerStep >= 1 ? 'opacity-100 translate-x-0' : 'opacity-50 translate-x-4'}`}>
                              <div className="absolute -left-[41px] top-0 w-8 h-8 rounded-full bg-slate-900 border-2 border-slate-700 flex items-center justify-center font-bold z-10 text-slate-500">2</div>
                              <div className="glass-panel rounded-xl overflow-hidden">
                                  <div className="p-4 bg-slate-800/50 border-b border-slate-700 cursor-pointer flex justify-between" onClick={()=>setOfferStep(1)}><h4 className="font-bold text-white">Sobre A</h4><Icons.ChevronDown/></div>
                                  {offerStep === 1 && (
                                      <div className="p-6 space-y-4">
                                          <div className="bg-slate-900 p-4 rounded border border-slate-700">
                                              <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-slate-400">ARCHIVOS</span><label className="cursor-pointer text-xs bg-slate-700 px-2 py-1 rounded text-white"><Icons.Plus size={12}/> Adjuntar<input type="file" className="hidden" onChange={(e)=>handleEnvelopeUpload(e, 'A')} /></label></div>
                                              {envelopeFiles.A.map((f, idx) => (<div key={idx} className="flex justify-between items-center bg-black/20 p-1.5 rounded"><span className="text-xs text-slate-300">{f.name}</span><button onClick={()=>deleteEnvelopeFile('A', idx)} className="text-red-400"><Icons.Trash2 size={14}/></button></div>))}
                                          </div>
                                          <button onClick={()=>setOfferStep(2)} className="btn-primary px-6 py-2 rounded-lg text-sm font-bold">Siguiente &rarr;</button>
                                      </div>
                                  )}
                              </div>
                          </div>
                          {/* STEP 3 */}
                          <div className={`relative transition-all duration-500 ${offerStep >= 2 ? 'opacity-100 translate-x-0' : 'opacity-50 translate-x-4'}`}>
                              <div className="absolute -left-[41px] top-0 w-8 h-8 rounded-full bg-slate-900 border-2 border-slate-700 flex items-center justify-center font-bold z-10 text-slate-500">3</div>
                              <div className="glass-panel rounded-xl overflow-hidden">
                                  <div className="p-4 bg-slate-800/50 border-b border-slate-700 cursor-pointer flex justify-between" onClick={()=>setOfferStep(2)}><h4 className="font-bold text-white">Sobre B (Técnico)</h4><Icons.ChevronDown/></div>
                                  {offerStep === 2 && (
                                      <div className="p-6 space-y-4">
                                          <div className="bg-slate-800 p-4 rounded-lg">
                                              <div className="flex justify-between items-center mb-2"><h5 className="font-bold text-white text-sm">Mejoras Técnicas</h5><button onClick={()=>getAdvice('technical')} className="text-xs bg-blue-600 px-3 py-1 rounded text-white font-bold">{loadingAdvice ? <Icons.Loader/> : 'Sugerir'}</button></div>
                                              <div className="text-xs text-slate-300 whitespace-pre-wrap">{aiAdvice.technical || "Pulsa para sugerencias."}</div>
                                          </div>
                                          <div className="bg-slate-900 p-4 rounded border border-slate-700">
                                              <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-slate-400">ARCHIVOS</span><label className="cursor-pointer text-xs bg-slate-700 px-2 py-1 rounded text-white"><Icons.Plus size={12}/> Adjuntar<input type="file" className="hidden" onChange={(e)=>handleEnvelopeUpload(e, 'B')} /></label></div>
                                              {envelopeFiles.B.map((f, idx) => (<div key={idx} className="flex justify-between items-center bg-black/20 p-1.5 rounded"><span className="text-xs text-slate-300">{f.name}</span><button onClick={()=>deleteEnvelopeFile('B', idx)} className="text-red-400"><Icons.Trash2 size={14}/></button></div>))}
                                          </div>
                                          <button onClick={()=>setOfferStep(3)} className="btn-primary px-6 py-2 rounded-lg text-sm font-bold">Siguiente &rarr;</button>
                                      </div>
                                  )}
                              </div>
                          </div>
                          {/* STEP 4 */}
                          <div className={`relative transition-all duration-500 ${offerStep >= 3 ? 'opacity-100 translate-x-0' : 'opacity-50 translate-x-4'}`}>
                              <div className="absolute -left-[41px] top-0 w-8 h-8 rounded-full bg-slate-900 border-2 border-slate-700 flex items-center justify-center font-bold z-10 text-slate-500">4</div>
                              <div className="glass-panel rounded-xl overflow-hidden">
                                  <div className="p-4 bg-slate-800/50 border-b border-slate-700 cursor-pointer flex justify-between" onClick={()=>setOfferStep(3)}><h4 className="font-bold text-white">Sobre C (Económico)</h4><Icons.ChevronDown/></div>
                                  {offerStep === 3 && (
                                      <div className="p-6 space-y-4">
                                          <div className="grid grid-cols-2 gap-4 bg-slate-900 p-4 rounded-xl border border-slate-700"><div><span className="text-xs text-slate-500 block">Tu Oferta</span><span className="text-green-400 font-mono font-bold text-lg">{formatCurrency(precioOfertado)}</span></div><div><span className="text-xs text-slate-500 block">Baja</span><span className="text-white font-bold">{baja.toFixed(2)}%</span></div></div>
                                          <div className="mt-4"><h5 className="font-bold text-white text-sm mb-2">Carta Proposición</h5><div className="bg-slate-900 p-4 rounded text-xs text-slate-300 font-mono h-32 overflow-y-auto whitespace-pre-wrap select-all border border-slate-700">{generateLetterText()}</div></div>
                                          <div className="bg-slate-900 p-4 rounded border border-slate-700">
                                              <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-slate-400">ARCHIVOS</span><label className="cursor-pointer text-xs bg-slate-700 px-2 py-1 rounded text-white"><Icons.Plus size={12}/> Adjuntar<input type="file" className="hidden" onChange={(e)=>handleEnvelopeUpload(e, 'C')} /></label></div>
                                              {envelopeFiles.C.map((f, idx) => (<div key={idx} className="flex justify-between items-center bg-black/20 p-1.5 rounded"><span className="text-xs text-slate-300">{f.name}</span><button onClick={()=>deleteEnvelopeFile('C', idx)} className="text-red-400"><Icons.Trash2 size={14}/></button></div>))}
                                          </div>
                                          <button onClick={window.print} className="bg-slate-700 hover:bg-slate-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 mx-auto mt-4"><Icons.Printer/> Imprimir Resumen</button>
                                      </div>
                                  )}
                              </div>
                          </div>
                      </div>
                  </div>
              );
          };

          return (
              <div className="h-full flex flex-col bg-[#0a0a0a]">
                  <header className="bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center no-print">
                      <div className="flex items-center gap-4">
                          <button onClick={onBack} className="text-slate-400 hover:text-white"><Icons.Briefcase size={20} className="rotate-90" /></button>
                          <div><h2 className="text-lg font-bold text-white truncate max-w-md">{localTender.title}</h2></div>
                      </div>
                      <div className="flex bg-slate-800 p-1 rounded-lg">
                           {[1,2,3,4,5].map(t => (
                               <button key={t} onClick={()=>setActiveTab(t)} className={`px-4 py-2 rounded text-xs font-bold transition-all ${activeTab===t ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'}`}>
                                   {t===1 && "1. Documentos"} {t===2 && "2. Análisis"} {t===3 && "3. Consultas IA"} {t===4 && "4. Calculadora"} {t===5 && "5. Asistente"}
                               </button>
                           ))}
                      </div>
                  </header>
                  <main className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                      <div className="max-w-5xl mx-auto">
                          {activeTab === 1 && (
                              <div className="space-y-6 fade-in no-print">
                                  <div className="glass-panel p-8 rounded-2xl text-center border-dashed border-2 border-slate-700 hover:border-blue-500 transition-colors">
                                      <div className="mb-4 text-blue-500 flex justify-center"><Icons.Upload size={48} /></div>
                                      <h3 className="text-xl font-bold text-white mb-2">Subir Pliegos (PDF)</h3>
                                      <p className="text-slate-400 text-sm mb-6">PCAP y PPT para análisis.</p>
                                      <label className="btn-primary px-8 py-3 rounded-xl cursor-pointer shadow-lg inline-flex items-center gap-2">
                                          {pdfProcessing ? <Icons.Loader/> : <Icons.Plus/>} Seleccionar
                                          <input type="file" multiple accept="application/pdf" className="hidden" onChange={handlePdfUpload} disabled={pdfProcessing}/>
                                      </label>
                                  </div>
                                  {localTender.files.length > 0 && (
                                      <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                                          {localTender.files.map((f, i) => (
                                              <div key={i} className="p-4 border-b border-slate-800 flex justify-between items-center last:border-0">
                                                  <div className="flex items-center gap-3"><span className="text-sm text-slate-200">{f.name}</span></div>
                                                  <div className="flex gap-2"><button onClick={()=>handleDownloadDoc(f.id, f.name)} className="text-slate-500 hover:text-blue-400"><Icons.Download size={18}/></button><button onClick={()=>handleDeleteFile(i)} className="text-slate-500 hover:text-red-400"><Icons.Trash2 size={18}/></button></div>
                                              </div>
                                          ))}
                                          <div className="p-4 bg-slate-800/30 flex justify-end"><button onClick={runAnalysis} disabled={isAnalyzing} className="btn-primary px-6 py-2 rounded-lg flex items-center gap-2 text-sm">{isAnalyzing ? <Icons.Loader/> : <Icons.BrainCircuit/>} ANALIZAR</button></div>
                                      </div>
                                  )}
                              </div>
                          )}
                          {activeTab === 2 && (
                              <div className="fade-in space-y-6 no-print">
                                  {!localTender.analysis ? (
                                      <div className="text-center py-20 text-slate-500">Ejecuta el análisis en Documentos.</div>
                                  ) : (
                                      <>
                                          <div className="glass-panel p-6 rounded-xl relative"><div className="absolute top-4 right-4"><CopyBtn text={JSON.stringify(localTender.analysis.resumen_ejecutivo, null, 2)}/></div><h4 className="text-blue-400 text-sm font-bold uppercase mb-4">Resumen Ejecutivo</h4><div className="grid grid-cols-2 gap-4 text-sm"><div><div className="text-xs text-slate-500">Organismo</div><div className="text-white">{localTender.analysis.resumen_ejecutivo?.organismo}</div></div><div><div className="text-xs text-slate-500">PBL</div><div className="text-green-400 font-bold">{formatCurrency(localTender.analysis.datos_economicos?.pbl_sin_iva)}</div></div><div className="col-span-2 text-white italic">{localTender.analysis.resumen_ejecutivo?.objeto_detallado}</div></div></div>
                                          <div className="grid grid-cols-2 gap-6">
                                              <div className="glass-panel p-6 rounded-xl"><h4 className="text-amber-400 text-sm font-bold uppercase mb-4">Criterios Adjudicación</h4><pre className="text-xs text-slate-300 whitespace-pre-wrap font-mono">{JSON.stringify(localTender.analysis.criterios_adjudicacion, null, 2)}</pre></div>
                                              <div className="glass-panel p-6 rounded-xl"><h4 className="text-purple-400 text-sm font-bold uppercase mb-4">Solvencia</h4><pre className="text-xs text-slate-300 whitespace-pre-wrap font-mono">{JSON.stringify(localTender.analysis.requisitos_admision, null, 2)}</pre></div>
                                          </div>
                                      </>
                                  )}
                              </div>
                          )}
                          {activeTab === 3 && (
                              <div className="fade-in h-[600px] glass-panel rounded-2xl flex flex-col overflow-hidden border border-slate-700 no-print">
                                  <div className="bg-slate-800/80 p-4 border-b border-slate-700 flex justify-between items-center">
                                      <div className="flex items-center gap-3"><div className="bg-blue-500/20 p-2 rounded text-blue-400"><Icons.MessageSquare size={20}/></div><div><h3 className="font-bold text-white text-sm">Interrogatorio de Documentación</h3><p className="text-xs text-slate-400">Pregunta sobre el pliego. Respuestas basadas estrictamente en el texto.</p></div></div>
                                      {suggestedQuestions.length === 0 && localTender.rawText && <button onClick={()=>generateSuggestedQuestions(apiKey, localTender).then(setSuggestedQuestions)} className="text-xs text-blue-400 hover:text-white flex items-center gap-1"><Icons.Sparkles size={12}/> Generar Sugerencias</button>}
                                  </div>
                                  <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-900/50">
                                      {suggestedQuestions.length > 0 && chatHistory.length === 0 && (
                                          <div className="mb-4">
                                              <p className="text-xs text-slate-500 uppercase font-bold mb-2">Preguntas sugeridas por la IA:</p>
                                              <div className="flex flex-wrap gap-2">
                                                  {suggestedQuestions.map((q, i) => (
                                                      <button key={i} onClick={()=>handleChatSend(q)} className="bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-full px-4 py-2 text-xs text-blue-300 transition-colors text-left">{q}</button>
                                                  ))}
                                              </div>
                                          </div>
                                      )}
                                      {chatHistory.map((msg, idx) => (
                                          <div key={idx} className={`chat-bubble ${msg.role === 'user' ? 'chat-user' : 'chat-ai'} flex flex-col`}>
                                              <div className="whitespace-pre-wrap">{msg.text}</div>
                                              {msg.role === 'ai' && <div className="mt-2 self-end"><CopyBtn text={msg.text} className="bg-black/20 hover:bg-black/40"/></div>}
                                          </div>
                                      ))}
                                      {chatLoading && <div className="flex justify-start"><div className="bg-slate-800 p-3 rounded-xl"><Icons.Loader className="text-blue-500"/></div></div>}
                                      <div ref={chatEndRef} />
                                  </div>
                                  <div className="p-4 bg-slate-800 border-t border-slate-700 flex gap-2">
                                      <input type="text" className="input-std" placeholder="Ej: ¿Qué penalidades existen por demora?" value={chatInput} onChange={e=>setChatInput(e.target.value)} onKeyDown={e=> e.key === 'Enter' && handleChatSend()}/>
                                      <button onClick={()=>handleChatSend()} disabled={!chatInput.trim() || chatLoading} className="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-lg disabled:opacity-50"><Icons.Send/></button>
                                  </div>
                              </div>
                          )}
                          {activeTab === 4 && (
                              <div className="fade-in max-w-3xl mx-auto no-print">
                                  <div className="glass-panel p-8 rounded-2xl shadow-2xl">
                                      <h3 className="text-2xl font-bold text-white mb-6 flex items-center gap-3"><Icons.Calculator/> Calculadora Oferta</h3>
                                      <div className="grid grid-cols-2 gap-8 mb-8"><div><label className="text-xs text-slate-400 font-bold block mb-2">Costes (€)</label><input type="number" className="input-std text-right font-mono text-lg" value={costes} onChange={e=>setCostes(parseFloat(e.target.value)||0)} /></div><div><label className="text-xs text-slate-400 font-bold block mb-2">Margen (%)</label><input type="number" className="input-std text-right font-mono text-lg text-yellow-400" value={margen} onChange={e=>setMargen(parseFloat(e.target.value)||0)} /></div></div>
                                      <div className="bg-slate-900 rounded-xl p-6 border border-slate-700 space-y-6"><div className="flex justify-between items-center"><span className="text-slate-400 text-sm">PBL</span><span className="text-white font-mono font-bold">{formatCurrency(pbl)}</span></div><div className="flex justify-between items-center"><span className="text-blue-400 text-sm font-bold">Venta Objetivo</span><span className="text-blue-300 font-mono font-bold text-xl">{formatCurrency(costes * (1 + margen/100))}</span></div><div className="h-px bg-slate-700 my-2"></div><div><label className="flex justify-between text-sm mb-2"><span className="text-white font-bold">Baja (%)</span> <span className="text-green-400 font-mono font-bold text-xl">{baja.toFixed(2)}%</span></label><input type="range" min="0" max="60" step="0.01" className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500" value={baja} onChange={e=>setBaja(parseFloat(e.target.value))} /></div><div className="flex justify-between bg-black/30 p-3 rounded border border-slate-600"><span className="text-sm text-slate-400">BENEFICIO</span><span className={`font-mono font-bold text-lg ${beneficio >= 0 ? 'text-green-400' : 'text-red-500'}`}>{formatCurrency(beneficio)}</span></div></div>
                                  </div>
                              </div>
                          )}
                          {activeTab === 5 && renderBidAssistant()}
                      </div>
                      <div className="print-only hidden p-8 bg-white text-black">
                         <h1 className="text-2xl font-bold mb-4">Resumen Técnico: {localTender.title}</h1>
                         <div className="whitespace-pre-wrap font-mono text-sm border-b pb-4 mb-4">{generateReportText(localTender.analysis)}</div>
                         {aiAdvice.economic && (<div className="mb-4"><h2 className="text-lg font-bold">Estrategia Económica</h2><p className="text-sm whitespace-pre-wrap">{aiAdvice.economic}</p></div>)}
                         <div className="mb-4"><strong>Oferta Final:</strong> {formatCurrency(precioOfertado)} (Baja: {baja.toFixed(2)}%)</div>
                      </div>
                  </main>
              </div>
          );
      };

      const Dashboard = ({ tenders, setTenders, onOpenTender, showPrompt }) => {
          const handleNew = () => {
              showPrompt('Nuevo Expediente', 'Título/Referencia:', 'Ej: Obras Reforma...', async (title) => {
                   const newT = { id: Date.now(), title, status: 'Nueva', files: [], analysis: null, envelopeFiles: {A:[], B:[], C:[]} };
                   await dbActions.put(DB_STORES.TENDERS, null, newT);
                   setTenders([newT, ...tenders]);
              });
          };

          return (
              <div className="p-6 h-full flex flex-col fade-in no-print">
                   <div className="flex justify-between items-center mb-8">
                      <div><h2 className="text-3xl font-display font-bold text-white tracking-tight">Expedientes</h2><p className="text-slate-400 text-sm">Gestión de licitaciones</p></div>
                      <button onClick={handleNew} className="btn-primary px-6 py-3 rounded-xl flex items-center gap-2 shadow-lg"><Icons.Plus/> Nuevo</button>
                  </div>
                  {tenders.length === 0 ? <div className="text-center py-20 text-slate-500">No hay licitaciones.</div> : (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 overflow-y-auto pb-20 custom-scrollbar">
                          {tenders.map(t => (
                              <div key={t.id} onClick={()=>onOpenTender(t)} className="glass-panel p-6 rounded-2xl cursor-pointer hover:bg-slate-800/80 transition-all hover:scale-[1.01] group border-l-4 border-l-transparent hover:border-l-blue-500">
                                  <h3 className="text-lg font-bold text-white mb-2 truncate">{t.title}</h3>
                                  <div className="text-xs text-slate-400">{t.analysis?.resumen_ejecutivo?.numero_expediente || 'Sin analizar'}</div>
                                  <div className="mt-4 pt-4 border-t border-slate-700/50 flex justify-between items-center"><span className="text-[10px] text-slate-500">{new Date(t.id).toLocaleDateString()}</span><span className="text-xs text-blue-400 font-bold group-hover:translate-x-1 transition-transform">Abrir &rarr;</span></div>
                              </div>
                          ))}
                      </div>
                  )}
              </div>
          );
      };

      const App = () => {
          const [view, setView] = useState('dashboard'); 
          const [tenders, setTenders] = useState([]);
          const [companies, setCompanies] = useState([]);
          const [activeTender, setActiveTender] = useState(null);
          const [rk, setRk] = usePersistentState('bg_app_rk_st', ''); 
          const [tc, setTc] = usePersistentState('bg_app_tc_st', 0); 
          const isAuth = _bg_check_sys(rk);
          const [modal, setModal] = useState({ open: false, title: '', message: '', type: '', onConfirm: null });
          const [promptModal, setPromptModal] = useState({ open: false, title: '', message: '', placeholder: '', onConfirm: null });
          const [apiKey] = usePersistentState('gemini_api_key', '');

          useEffect(() => { const init = async () => { setTenders(await dbActions.getAll(DB_STORES.TENDERS)); setCompanies(await dbActions.getAll(DB_STORES.COMPANIES)); }; init(); }, [view]);

          const showModal = (title, message, type = 'default', onConfirm = null) => { setModal({ open: true, title, message, type, onConfirm }); };
          const showPrompt = (title, message, placeholder, onConfirm) => { setPromptModal({ open: true, title, message, placeholder, onConfirm }); };
          const handleActivate = (code) => { if(!code) return; if(_bg_check_sys(code)) { setRk(code); showModal('ACTIVADO', 'Sistema registrado.', 'success'); } else { setRk(''); showModal('ERROR', 'Código inválido.', 'danger'); } };
          const handleOpenTender = (t) => { if (!isAuth && tc >= 10) { showModal('Prueba Fin', 'Límite alcanzado.', 'danger', () => setView('settings')); return; } if(!isAuth) setTc(prev => prev + 1); setActiveTender(t); setView('workspace'); };

          return (
              <div className="h-full flex flex-col text-white overflow-hidden">
                  {view !== 'workspace' && (
                      <nav className="shrink-0 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 px-6 py-4 flex justify-between items-center z-20 no-print">
                          <div><div className="text-3xl font-display font-bold tracking-tight leading-none"><span className="text-white">Boarding</span><span className="text-blue-600">Gate</span></div></div>
                          <div className="flex bg-slate-800 rounded-lg p-1 gap-1">
                              <button onClick={()=>setView('dashboard')} className={`px-4 py-2 rounded text-xs font-bold uppercase transition-all flex items-center gap-2 ${view==='dashboard'?'bg-blue-600 text-white':'text-slate-400 hover:text-white'}`}><Icons.Briefcase size={16}/> Licitaciones</button>
                              <button onClick={()=>setView('companies')} className={`px-4 py-2 rounded text-xs font-bold uppercase transition-all flex items-center gap-2 ${view==='companies'?'bg-blue-600 text-white':'text-slate-400 hover:text-white'}`}><Icons.Building size={16}/> Empresas</button>
                              <button onClick={()=>setView('settings')} className={`px-4 py-2 rounded text-xs font-bold uppercase transition-all flex items-center gap-2 ${view==='settings'?'bg-blue-600 text-white':'text-slate-400 hover:text-white'}`}><Icons.Settings size={16}/> Config</button>
                          </div>
                      </nav>
                  )}
                  <div className="flex-1 overflow-hidden relative">
                      {view === 'dashboard' && <Dashboard tenders={tenders} setTenders={setTenders} onOpenTender={handleOpenTender} showPrompt={showPrompt} />}
                      {view === 'companies' && <CompanyManager companies={companies} setCompanies={setCompanies} showModal={showModal} />}
                      {view === 'workspace' && activeTender && <Workspace tender={activeTender} onBack={()=>setView('dashboard')} apiKey={apiKey} companies={companies} showModal={showModal} />}
                      {view === 'settings' && <SettingsTab isAuth={isAuth} trialCount={tc} onActivate={handleActivate} />}
                  </div>
                  <Modal isOpen={modal.open} title={modal.title} message={modal.message} type={modal.type} onClose={() => setModal({ ...modal, open: false })} onConfirm={modal.onConfirm ? () => { modal.onConfirm(); setModal({ ...modal, open: false }); } : null}/>
                  <PromptModal isOpen={promptModal.open} title={promptModal.title} message={promptModal.message} placeholder={promptModal.placeholder} onClose={() => setPromptModal({ ...promptModal, open: false })} onConfirm={(val) => { promptModal.onConfirm(val); setPromptModal({ ...promptModal, open: false }); }}/>
              </div>
          );
      };

      createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
